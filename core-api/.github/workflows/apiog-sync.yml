name: Sync Apidog Documentation

on:
  push:
    branches:
      - main

jobs:
  sync-docs:
    name: Generate & Sync Swagger to Apidog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync API Doc to Apidog
        run: |
          # swagger.json 파일을 읽어서 JSON 문자열로 변환
          SWAGGER_CONTENT=$(cat swagger.json | jq -c .)

          # JSON body 생성
          JSON_BODY=$(jq -n \
            --arg input "$SWAGGER_CONTENT" \
            --arg branch "$TARGET_APIDOG_BRANCH" \
            '{
              input: $input,
              options: {
                endpointOverwriteBehavior: "OVERWRITE_EXISTING",
                schemaOverwriteBehavior: "OVERWRITE_EXISTING",
                updateFolderOfChangedEndpoint: false,
                prependBasePath: false
              }
            }')

          # https://openapi.apidog.io/import-openapiswagger-data-7312738e0 해당 문서 참고
          curl -v --location --request POST "https://api.apidog.com/v1/projects/1134504/import-openapi" \
          --header "X-Apidog-Api-Version: 2024-03-28" \
          --header "Authorization: Bearer APS-GSvqfuLyf5RfQBrM037WWlm7PEeU5Thi" \
          --header "Content-Type: application/json" \
          --data-raw "$JSON_BODY"
