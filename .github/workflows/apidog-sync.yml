name: Core API - Sync Apidog Documentation

on:
  push:
    branches:
      - main
      - dev
    paths:
      - "core-api/**"
      - ".github/workflows/apidog-sync.yml"

jobs:
  sync-docs:
    name: Generate & Sync Swagger to Apidog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Node.js ÌôòÍ≤Ω ÏÑ§Ï†ï (Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§ÌñâÏö©)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "./core-api/package-lock.json"

      # 2. ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò (NestJS, sqlite3 Îì± ÌïÑÏöî)
      - name: Install Dependencies
        working-directory: ./core-api
        run: npm ci

      # 3. Swagger ÌååÏùº ÏÉùÏÑ± (Mock DB ÏÇ¨Ïö©)
      # package.jsonÏóê "generate:swagger": "cross-env SWAGGER_GEN=true ts-node generate-swagger.ts" Í∞Ä ÏûàÏñ¥Ïïº Ìï®
      - name: Generate Swagger Files
        working-directory: ./core-api
        run: npm run generate:swagger
        env:
          SWAGGER_GEN: "true" # Í∞ÄÏßú DB ÏÇ¨Ïö© Ìä∏Î¶¨Í±∞

      # 4. ApidogÎ°ú Ï†ÑÏÜ° (Í∏∞Ï°¥ Î°úÏßÅ + Secrets Ï†ÅÏö©)
      - name: Sync API Doc to Apidog
        working-directory: ./core-api
        env:
          TARGET_APIDOG_BRANCH: ${{ github.ref_name }}
          APIDOG_TOKEN: ${{ secrets.APIDOG_TOKEN }} # Secrets ÏÇ¨Ïö© ÌïÑÏàò!
        run: |
          # Î∏åÎûúÏπòÏóê Îî∞Î•∏ Apidog ÌÉÄÍ≤ü Î∏åÎûúÏπò ID Îß§Ìïë
          if [ "$TARGET_APIDOG_BRANCH" == "main" ]; then
            TARGET_APIDOG_BRANCH=1126584
          else
            TARGET_APIDOG_BRANCH=1126805
          fi

          echo "üöÄ Syncing to Apidog Branch ID: $TARGET_APIDOG_BRANCH"

          # ---------------------------------------------------------
          # 1. Main API Sync
          # ---------------------------------------------------------
          if [ -f "swagger.json" ]; then
            echo "Processing swagger.json..."
            SWAGGER_CONTENT=$(cat swagger.json | jq -c .)
            
            JSON_BODY=$(jq -n \
              --arg input "$SWAGGER_CONTENT" \
              --arg branch "$TARGET_APIDOG_BRANCH" \
              '{
                input: $input,
                options: {
                  endpointOverwriteBehavior: "OVERWRITE_EXISTING",
                  schemaOverwriteBehavior: "OVERWRITE_EXISTING",
                  updateFolderOfChangedEndpoint: false,
                  prependBasePath: false,
                  targetEndpointFolderId: 5689113,
                  targetBranchId: $branch
                }
              }')

            curl -v --location --request POST "https://api.apidog.com/v1/projects/1134504/import-openapi" \
            --header "X-Apidog-Api-Version: 2024-03-28" \
            --header "Authorization: Bearer $APIDOG_TOKEN" \
            --header "Content-Type: application/json" \
            --data-raw "$JSON_BODY"
          else
            echo "‚ö†Ô∏è swagger.json not found! Skipping..."
          fi

          # ---------------------------------------------------------
          # 2. Admin API Sync (ÌååÏùºÏù¥ Ï°¥Ïû¨Ìï† Í≤ΩÏö∞ÏóêÎßå Ïã§Ìñâ)
          # ---------------------------------------------------------
          if [ -f "swagger-admin.json" ]; then
            echo "Processing swagger-admin.json..."
            SWAGGER_ADMIN_CONTENT=$(cat swagger-admin.json | jq -c .)

            JSON_BODY_ADMIN=$(jq -n \
              --arg input "$SWAGGER_ADMIN_CONTENT" \
              --arg branch "$TARGET_APIDOG_BRANCH" \
              '{
                input: $input,
                options: {
                  endpointOverwriteBehavior: "OVERWRITE_EXISTING",
                  schemaOverwriteBehavior: "OVERWRITE_EXISTING",
                  updateFolderOfChangedEndpoint: false,
                  prependBasePath: false,
                  targetEndpointFolderId: 5689111,
                  targetBranchId: $branch
                }
              }')

            curl -v --location --request POST "https://api.apidog.com/v1/projects/1134504/import-openapi" \
            --header "X-Apidog-Api-Version: 2024-03-28" \
            --header "Authorization: Bearer $APIDOG_TOKEN" \
            --header "Content-Type: application/json" \
            --data-raw "$JSON_BODY_ADMIN"
          else
            echo "‚ö†Ô∏è swagger-admin.json not found! Skipping..."
          fi
